<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Legion of Blood</title>
<style>
  * { padding: 0; margin: 0; }
  canvas { background: #eee; display: block; margin: 0 auto; }
  #pause { position: absolute; left: 10px; top: 40px; }
  #step { position: absolute; left: 10px; top: 60px; }
</style>
</head>
<body>
<canvas id="canvas" width="800" height="600"></canvas>
<button id="pause">pause</button>
<button id="step">step</button>
<script src="../chansock.js"></script>
<script src="../buzz.js"></script>
<script src="../gb0x.js"></script>
<script>
  var canvas = document.getElementById("canvas");
  var ctx = canvas.getContext("2d");
  var gb0x = GB0X({canvas: canvas});
  gb0x.autoAdaptCanvas();

  var imagePixels = {};
  var images = {
    'grass1':   gb0x.loadImage('img/tropic_grass_c.png', function(d){imagePixels['grass1'] = d}),
    'grass2':   gb0x.loadImage('img/temp_grass_2.png', function(d){imagePixels['grass2'] = d}),
    'dirt1':    gb0x.loadImage('img/dirt_burned.png', function(d){imagePixels['dirt1'] = d}),
    'dirt2':    gb0x.loadImage('img/dirt_flaky.png', function(d){imagePixels['dirt2'] = d}),
    'sand1':    gb0x.loadImage('img/desert_rough.png', function(d){imagePixels['sand1'] = d}),
    'sand2':    gb0x.loadImage('img/desert_sand_scrub.png', function(d){imagePixels['sand2'] = d}),
    'lava' :    gb0x.loadImage('img/cliff volcanic ground.png', function(d){imagePixels['lava'] = d}),

  };

  // var animations = {
  //   'skate1': gb0x.createAnimation([images['team1-skate1'], images['team1-skate2']], 500),
  //   'skate2': gb0x.createAnimation([images['team2-skate1'], images['team2-skate2']], 500),
  // };
  // var sounds = {
  //   'punch':   gb0x.loadSound('snd/punch.mp3'),
  //   'bump1':   gb0x.loadSound('snd/bump1.mp3'),
  //   'bump2':   gb0x.loadSound('snd/bump2.mp3'),
  //   'break':   gb0x.loadSound('snd/break.mp3'),
  // };

  var map = [];
  var gameObjects = [];

  // for(var x=0; x<canvas.width/256; x++){
  //   for(var y=0; y<canvas.height/256; y++){
  //     if(!map[y]) map[y] = [];
  //     map[y][x] = Math.random()<0.5 ? images['grass1'] : images['grass2'];
  //   }
  // }

  function vec2angle(){ return (Math.atan2(this.vy, this.vx)*gb0x.TO_DEG) + 90; }
  function findGameObjectIndexById(id){ return gameObjects.findIndex(function(e){return e.id == id}); }
  function findGameObjectById(id){ return gameObjects.find(function(e){return e.id == id}); }

  /* Socket events */
  var sock = createChannelSocket();
  sock.onclose = function(){ console.log('disconnected') };
  sock.onopen = function(){
    console.log('connected');

    sock.on('connect', function(d,f,c){ /* player connected, let's add him to the game */
      console.log('player connected: '+f);
      gameObjects.push({
        id: f,
        type: 'player',
        x: canvas.width / 2,
        y: canvas.height / 2,
        vx: 0, // velocity
        vy: 0,
        vxd: 0, // velocity
        vyd: 0,
        angle: vec2angle,
        radius: 25,
        weight: 80,
        score: 0,
        state: null,
        username: 'Player_'+gameObjects.length
      });
    });

    sock.on('disconnect', function(d,f,c){ /* player disconnected, let's remove him from the game */
      var i = findGameObjectIndexById(f); if(i==-1)return;
      console.log('player disconnected: '+f);
      gameObjects.splice(i,1);
    });

    sock.on('movement', function(d,f,c){ /* player sent movement command */
      var i = findGameObjectIndexById(f); if(i==-1)return;
      if(gameObjects[i].state=='knocked out') return;
      gameObjects[i].vxd = d.vxd;
      gameObjects[i].vyd = d.vyd;
    });

    sock.on('punch', function(d,f,c){ /* player punches */
      // var i = findGameObjectIndexById(f); if(i==-1)return;
      // if(gameObjects[i].state != 'punching'){
      //   gameObjects[i].state = 'punching';
      //   setTimeout(function(){gameObjects[i].state = null}, 250);
      //   var closest = closestFromOtherTeam(gameObjects[i]);
      //   if(closest[1] < gameObjects[i].radius*3){
      //     closest[0].state = 'knocked out';
      //     findGameObjectById('puck').held_by_id = null;
      //     setTimeout(function(){closest[0].state = null}, 3000);
      //   }
      // }
    });

    sock.on('hold', function(d,f,c){ /* player tries to hold the puck */
      // var i = findGameObjectIndexById(f); if(i==-1)return;
      // var j = findGameObjectIndexById('puck'); if(j==-1)return;
      // if(gb0x.distance(gameObjects[i], gameObjects[j]) < gameObjects[i].radius*2.5){
      //   console.log('hold puck')
      //   gameObjects[i].state = 'holding puck';
      //   gameObjects[j].held_by_id = gameObjects[i].id;
      //   gameObjects[j].last_player_id = gameObjects[i].id;
      // }else{
      //   console.log('puck too far')
      // }
    });

    sock.on('shoot', function(d,f,c){ /* player tries to shoot the puck */
      // var i = findGameObjectIndexById(f); if(i==-1)return;
      // var j = findGameObjectIndexById('puck'); if(j==-1)return;
      // if(gameObjects[i].state == 'holding puck' && gb0x.distance(gameObjects[i], gameObjects[j]) < gameObjects[i].radius*2.5){
      //   gameObjects[i].state = null;
      //   var player = findGameObjectById(gameObjects[j].held_by_id);
      //   var normalizedVelocity = gb0x.normalizeVector(player.vx, player.vy);
      //   gameObjects[j].vx = normalizedVelocity[0] * 20;
      //   gameObjects[j].vy = normalizedVelocity[1] * 20;
      //   gameObjects[j].held_by_id = null;
      //   console.log('shooting puck!');
      // }else{
      //   console.log('not holding puck or puck too far');
      // }
    });

    sock.on('username', function(d,f,c){ /* player wants to set/change his username */
      var i = findGameObjectIndexById(f); if(i==-1)return;
      gameObjects[i].username = d.username;
    });
  };

  function centeredText(text, x, y, c, font){
    ctx.save();
    ctx.font = font || "16px Arial";
    ctx.fillStyle = c || "#0095DD";
    ctx.fillText(text, x - ctx.measureText(text).width / 2, y);
    ctx.restore();
  }

  function between(min,max,x){ return Math.min(Math.max(x, min), max) }

  console.logOnce = function(){
    console._log_once_memory = console._log_once_memory || {};
    var pos = (new Error()).stack.split("\n",2)[1];
    if(console._log_once_memory[pos]) return;
    console._log_once_memory[pos] = true;
    return console.log.apply(this, arguments);
  };

  function drawMap(map,xo,yo){
    var t = 512, th = t/2;
    var w = canvas.width, h = canvas.height;
    var c = ctx.createImageData(w, h), d = c.data;
    var i, tmp, p = [];
    for(var y=0; y<10; y++){
      for(var x=0; x<w; x++){
        i = 4 * (y * w + x);
        //console.log([Math.floor(x/th), Math.floor(y/th)], [x%t, y%t]);
        //p[0] = map[[Math.floor(x/th), Math.floor(y/th)]];
        //console.log(p[0]);
        p[0] = map[Math.floor(y/th)][Math.floor(x/th)].getContext('2d').getImageData(x%t, y%t, 1, 1).data;

        //console.log(tmp, map[tmp], images[map[tmp]]);
        //if(!(p[0] = cache[tmp])) p[0] = cache[tmp] = images[map[tmp]].getContext('2d').getImageData(x%t, y%t, 1, 1).data;
        d[i  ] = p[0][0];//(255/w) * x;
        d[i+1] = p[0][1];//(255/h) * y;
        d[i+2] = p[0][2];//0;
        d[i+3] = p[0][3];//255;
      }
    }
    ctx.putImageData(c, 0, 0);
  }

  function dist(x1,y1,x2,y2){
    var xd = x1 - x2, yd = y1 - y2;
    return Math.sqrt(xd*xd + yd*yd);
  }

  function blendTiles(tiles){
    var can = document.createElement('canvas');
    var size = tiles[0].tile.width;
    can.width = size;
    can.height = size;
    var con = can.getContext('2d');
    var img = con.createImageData(size, size);
    var dat = img.data;
    for(var i=0; i<tiles.length; i++){
      tiles[i].data = tiles[i].tile.getContext('2d').getImageData(0, 0, size, size).data;
    }
    var blendCount = tiles.length; //tiles.length / 2;
    var closest = [];
    var dx,dy;
    var idx;
    var north, east, south, west;
    var nf,ef,sf,wf;
    for(var y=0; y<size; y++){
      for(var x=0; x<size; x++){
        for(var i=0; i<tiles.length; i++){
          tiles[i].dist = dist(x-size/2, y-size/2, tiles[i].pos[0]*size, tiles[i].pos[1]*size);
          if(tiles[i].pos[0] == 0 && tiles[i].pos[1] == -1) north = tiles[i].data;
          else if(tiles[i].pos[0] == 1 && tiles[i].pos[1] == 0) east = tiles[i].data;
          else if(tiles[i].pos[0] == 0 && tiles[i].pos[1] == 1) south = tiles[i].data;
          else if(tiles[i].pos[0] == -1 && tiles[i].pos[1] == 0) west = tiles[i].data;
        }
        tiles.sort(function(a,b){return a.dist-b.dist});
        closest = tiles.slice(0, blendCount);
        idx = 4*(y*size+x);
        //d = 0;
        //for(var i=0; i<blendCount; i++){ d+=closest[i].dist }
        //d /= blendCount;

        if(x<size/2){
          if(y<size/2){
            dx = x/(size/2); dy = y/(size/2);
            nf = ((1-dy)+dx)*0.5; wf = ((1-dx)+dy)*0.5; ef = 0; sf = 0;
            dat[idx  ] = (north[idx]*nf + east[idx]*ef + south[idx]*sf + west[idx]*wf);
            dat[idx+1] = (north[idx+1]*nf + east[idx+1]*ef + south[idx+1]*sf + west[idx+1]*wf);
            dat[idx+2] = (north[idx+2]*nf + east[idx+2]*ef + south[idx+2]*sf + west[idx+2]*wf);
            dat[idx+3] = (north[idx+3]*nf + east[idx+3]*ef + south[idx+3]*sf + west[idx+3]*wf);
          }else{
            dx = x/(size/2); dy = (y-size/2)/(size/2);
            nf = 0; wf = ((1-dx)+(1-dy))*0.5; ef = 0; sf = (dy+dx)*0.5;
            dat[idx  ] = (north[idx]*nf + east[idx]*ef + south[idx]*sf + west[idx]*wf);
            dat[idx+1] = (north[idx+1]*nf + east[idx+1]*ef + south[idx+1]*sf + west[idx+1]*wf);
            dat[idx+2] = (north[idx+2]*nf + east[idx+2]*ef + south[idx+2]*sf + west[idx+2]*wf);
            dat[idx+3] = (north[idx+3]*nf + east[idx+3]*ef + south[idx+3]*sf + west[idx+3]*wf);
          }
        }else{
          if(y<size/2){
            dx = (x-size/2)/(size/2); dy = y/(size/2);
            nf = ((1-dy)+(1-dx))*0.5; wf = 0; ef = (dx+dy)*0.5; sf = 0;
            dat[idx  ] = (north[idx]*nf + east[idx]*ef + south[idx]*sf + west[idx]*wf);
            dat[idx+1] = (north[idx+1]*nf + east[idx+1]*ef + south[idx+1]*sf + west[idx+1]*wf);
            dat[idx+2] = (north[idx+2]*nf + east[idx+2]*ef + south[idx+2]*sf + west[idx+2]*wf);
            dat[idx+3] = (north[idx+3]*nf + east[idx+3]*ef + south[idx+3]*sf + west[idx+3]*wf);
          }else{
            dx = (x-size/2)/(size/2); dy = (y-size/2)/(size/2);
            nf = 0; wf = 0; ef = (dx+(1-dy))*0.5; sf = (dy+(1-dx))*0.5;
            dat[idx  ] = (north[idx]*nf + east[idx]*ef + south[idx]*sf + west[idx]*wf);
            dat[idx+1] = (north[idx+1]*nf + east[idx+1]*ef + south[idx+1]*sf + west[idx+1]*wf);
            dat[idx+2] = (north[idx+2]*nf + east[idx+2]*ef + south[idx+2]*sf + west[idx+2]*wf);
            dat[idx+3] = (north[idx+3]*nf + east[idx+3]*ef + south[idx+3]*sf + west[idx+3]*wf);
          }
        }

        //for(var i=0; i<blendCount; i++){
        //  dat[idx  ] += closest[i].data[idx  ] * (i==(y > 256 ? 1 : 0) ? 1-dy : dy);//(d/closest[i].dist/blendCount);
        //  dat[idx+1] += closest[i].data[idx+1] * (i==(y > 256 ? 1 : 0) ? 1-dy : dy);//(d/closest[i].dist/blendCount);
        //  dat[idx+2] += closest[i].data[idx+2] * (i==(y > 256 ? 1 : 0) ? 1-dy : dy);//(d/closest[i].dist/blendCount);
        //  dat[idx+3] += closest[i].data[idx+3] * (i==(y > 256 ? 1 : 0) ? 1-dy : dy);//(d/closest[i].dist/blendCount);
        //}
      }
    }

    con.putImageData(img, 0, 0);
    return can;
  }


  var blended;
  function blendMyTiles(){
    if(gb0x.assetsLoaded()){
      blended = blendTiles([
        {tile: images['lava'],   pos: [0,-1]},
        {tile: images['dirt1'],  pos: [1, 0]},
        {tile: images['grass2'], pos: [0, 1]},
        {tile: images['sand1'],  pos: [-1,0]},
      ]);
    }else{
      setTimeout(blendMyTiles, 100);
    }
  }

  blendMyTiles();


  var EPSILON = 0.0001;
  /* Game loop! */
  var runner = gb0x.createRunner(function(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.drawImage(images['lava'], 256, 0, 256, 256);
    ctx.drawImage(images['dirt1'], 256*2, 256, 256, 256);
    ctx.drawImage(images['grass2'], 256, 256*2, 256, 256);
    ctx.drawImage(images['sand1'], 0, 256, 256, 256);
    if(blended) ctx.drawImage(blended, 256, 256, 256, 256);

    // ctx.globalAlpha = 0.5;
    // for(var x=0; x<canvas.width/256; x++){
    //   for(var y=0; y<canvas.height/256; y++){
    //     ctx.drawImage(images[map[x+'/'+y]], x*256, y*256, 512, 512);
    //   }
    // }
    // ctx.globalAlpha = 1;
    //drawMap(map);
    //ctx.drawImage(images.grass1, 256, 256, 512, 512);

    // ctx.globalAlpha = 0.5;
    // ctx.drawImage(images['rink_mask'], 0, 0, canvas.width, canvas.height);
    // ctx.globalAlpha = 1;

    /* detect collisions */
    var collisions = gb0x.collisions(gameObjects, gb0x.circleCollision);
    for(var i=0; i<collisions.length; i++){
      var objA = gameObjects[collisions[i][0]], objB = gameObjects[collisions[i][1]];
      var cr = gb0x.collisionResolver(objA, objB);
      objA.x = cr.p1[0];
      objA.y = cr.p1[1];
      objB.x = cr.p2[0];
      objB.y = cr.p2[1];
      objA.vx = cr.v1[0];
      objA.vy = cr.v1[1];
      objB.vx = cr.v2[0];
      objB.vy = cr.v2[1];
    }

    /* handle all game objects */
    for(var i=0; i<gameObjects.length; i++){
      var obj = gameObjects[i];

      if(obj.type == 'player'){
        centeredText(obj.username+' ('+obj.score+')', obj.x, obj.y - 30);
        if(obj.state == 'punching'){
          gb0x.drawImage(images['team'+obj.team+'-attack'], obj.x, obj.y, obj.angle());
        } else if(obj.state == 'knocked out'){
          gb0x.drawImage(images['team'+obj.team+'-down'], obj.x, obj.y, obj.angle());
        } else {
          if(Math.abs(obj.vx) + Math.abs(obj.vy) > 2)
            gb0x.drawAnimation(animations['skate'+obj.team], obj.x, obj.y, obj.angle());
          else
            gb0x.drawImage(images['team'+obj.team+'-idle'], obj.x, obj.y, obj.angle());
        }
        obj.vx = between(-4, 4, obj.vx + obj.vxd);
        obj.vy = between(-4, 4, obj.vy + obj.vyd);
      }

      if((obj.vx < -EPSILON || obj.vx > EPSILON) || (obj.vy < -EPSILON || obj.vy > EPSILON)){
        obj.x += obj.vx;
        obj.y += obj.vy;
        obj.vxd *= 0.5;
        obj.vyd *= 0.5;
      }
    }

    if(runner){ ctx.fillText(runner.fps()+' fps', 20, 20) }
  }, 50);//.run();

  document.getElementById('pause').addEventListener('click', function(){
    runner.toggle();
  });

  document.getElementById('step').addEventListener('click', function(){
    runner.step();
  });

</script>
</body>
</html>
